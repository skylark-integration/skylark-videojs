{"version":3,"sources":["utils/events.js"],"names":["define","document","DomData","Guid","log","_cleanUpEvents","elem","type","has","data","get","handlers","length","removeEventListener","dispatcher","detachEvent","Object","getOwnPropertyNames","disabled","delete","_handleMultipleEvents","fn","types","callback","forEach","fixEvent","event","fixed_","returnTrue","returnFalse","isPropagationStopped","old","window","key","preventDefault","target","srcElement","relatedTarget","fromElement","toElement","returnValue","defaultPrevented","stopPropagation","cancelBubble","stopImmediatePropagation","isImmediatePropagationStopped","clientX","undefined","doc","documentElement","body","pageX","scrollLeft","clientLeft","pageY","clientY","scrollTop","clientTop","which","charCode","keyCode","button","_supportsPassive","supportsPassive","opts","defineProperty","[object Object]","addEventListener","e","passiveEvents","on","Array","isArray","set","guid","newGUID","push","hash","handlersCopy","slice","m","n","call","error","options","indexOf","passive","attachEvent","off","removeType","el","t","prototype","hasOwnProperty","splice","trigger","elemData","parent","parentNode","ownerDocument","bubbles","targetData","one","func","apply","this","arguments","any"],"mappings":"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","file":"../../utils/events.js","sourcesContent":["define([\n    'skylark-langx-globals/document',\n    './dom-data',\n    './guid',\n    './log'\n], function (document, DomData, Guid, log) {\n    'use strict';\n    function _cleanUpEvents(elem, type) {\n        if (!DomData.has(elem)) {\n            return;\n        }\n        const data = DomData.get(elem);\n        if (data.handlers[type].length === 0) {\n            delete data.handlers[type];\n            if (elem.removeEventListener) {\n                elem.removeEventListener(type, data.dispatcher, false);\n            } else if (elem.detachEvent) {\n                elem.detachEvent('on' + type, data.dispatcher);\n            }\n        }\n        if (Object.getOwnPropertyNames(data.handlers).length <= 0) {\n            delete data.handlers;\n            delete data.dispatcher;\n            delete data.disabled;\n        }\n        if (Object.getOwnPropertyNames(data).length === 0) {\n            DomData.delete(elem);\n        }\n    }\n    function _handleMultipleEvents(fn, elem, types, callback) {\n        types.forEach(function (type) {\n            fn(elem, type, callback);\n        });\n    }\n    function fixEvent(event) {\n        if (event.fixed_) {\n            return event;\n        }\n        function returnTrue() {\n            return true;\n        }\n        function returnFalse() {\n            return false;\n        }\n        if (!event || !event.isPropagationStopped) {\n            const old = event || window.event;\n            event = {};\n            for (const key in old) {\n                if (key !== 'layerX' && key !== 'layerY' && key !== 'keyLocation' && key !== 'webkitMovementX' && key !== 'webkitMovementY') {\n                    if (!(key === 'returnValue' && old.preventDefault)) {\n                        event[key] = old[key];\n                    }\n                }\n            }\n            if (!event.target) {\n                event.target = event.srcElement || document;\n            }\n            if (!event.relatedTarget) {\n                event.relatedTarget = event.fromElement === event.target ? event.toElement : event.fromElement;\n            }\n            event.preventDefault = function () {\n                if (old.preventDefault) {\n                    old.preventDefault();\n                }\n                event.returnValue = false;\n                old.returnValue = false;\n                event.defaultPrevented = true;\n            };\n            event.defaultPrevented = false;\n            event.stopPropagation = function () {\n                if (old.stopPropagation) {\n                    old.stopPropagation();\n                }\n                event.cancelBubble = true;\n                old.cancelBubble = true;\n                event.isPropagationStopped = returnTrue;\n            };\n            event.isPropagationStopped = returnFalse;\n            event.stopImmediatePropagation = function () {\n                if (old.stopImmediatePropagation) {\n                    old.stopImmediatePropagation();\n                }\n                event.isImmediatePropagationStopped = returnTrue;\n                event.stopPropagation();\n            };\n            event.isImmediatePropagationStopped = returnFalse;\n            if (event.clientX !== null && event.clientX !== undefined) {\n                const doc = document.documentElement;\n                const body = document.body;\n                event.pageX = event.clientX + (doc && doc.scrollLeft || body && body.scrollLeft || 0) - (doc && doc.clientLeft || body && body.clientLeft || 0);\n                event.pageY = event.clientY + (doc && doc.scrollTop || body && body.scrollTop || 0) - (doc && doc.clientTop || body && body.clientTop || 0);\n            }\n            event.which = event.charCode || event.keyCode;\n            if (event.button !== null && event.button !== undefined) {\n                event.button = event.button & 1 ? 0 : event.button & 4 ? 1 : event.button & 2 ? 2 : 0;\n            }\n        }\n        event.fixed_ = true;\n        return event;\n    }\n    let _supportsPassive;\n    const supportsPassive = function () {\n        if (typeof _supportsPassive !== 'boolean') {\n            _supportsPassive = false;\n            try {\n                const opts = Object.defineProperty({}, 'passive', {\n                    get() {\n                        _supportsPassive = true;\n                    }\n                });\n                window.addEventListener('test', null, opts);\n                window.removeEventListener('test', null, opts);\n            } catch (e) {\n            }\n        }\n        return _supportsPassive;\n    };\n    const passiveEvents = [\n        'touchstart',\n        'touchmove'\n    ];\n    function on(elem, type, fn) {\n        if (Array.isArray(type)) {\n            return _handleMultipleEvents(on, elem, type, fn);\n        }\n        if (!DomData.has(elem)) {\n            DomData.set(elem, {});\n        }\n        const data = DomData.get(elem);\n        if (!data.handlers) {\n            data.handlers = {};\n        }\n        if (!data.handlers[type]) {\n            data.handlers[type] = [];\n        }\n        if (!fn.guid) {\n            fn.guid = Guid.newGUID();\n        }\n        data.handlers[type].push(fn);\n        if (!data.dispatcher) {\n            data.disabled = false;\n            data.dispatcher = function (event, hash) {\n                if (data.disabled) {\n                    return;\n                }\n                event = fixEvent(event);\n                const handlers = data.handlers[event.type];\n                if (handlers) {\n                    const handlersCopy = handlers.slice(0);\n                    for (let m = 0, n = handlersCopy.length; m < n; m++) {\n                        if (event.isImmediatePropagationStopped()) {\n                            break;\n                        } else {\n                            try {\n                                handlersCopy[m].call(elem, event, hash);\n                            } catch (e) {\n                                log.error(e);\n                            }\n                        }\n                    }\n                }\n            };\n        }\n        if (data.handlers[type].length === 1) {\n            if (elem.addEventListener) {\n                let options = false;\n                if (supportsPassive() && passiveEvents.indexOf(type) > -1) {\n                    options = { passive: true };\n                }\n                elem.addEventListener(type, data.dispatcher, options);\n            } else if (elem.attachEvent) {\n                elem.attachEvent('on' + type, data.dispatcher);\n            }\n        }\n    }\n    function off(elem, type, fn) {\n        if (!DomData.has(elem)) {\n            return;\n        }\n        const data = DomData.get(elem);\n        if (!data.handlers) {\n            return;\n        }\n        if (Array.isArray(type)) {\n            return _handleMultipleEvents(off, elem, type, fn);\n        }\n        const removeType = function (el, t) {\n            data.handlers[t] = [];\n            _cleanUpEvents(el, t);\n        };\n        if (type === undefined) {\n            for (const t in data.handlers) {\n                if (Object.prototype.hasOwnProperty.call(data.handlers || {}, t)) {\n                    removeType(elem, t);\n                }\n            }\n            return;\n        }\n        const handlers = data.handlers[type];\n        if (!handlers) {\n            return;\n        }\n        if (!fn) {\n            removeType(elem, type);\n            return;\n        }\n        if (fn.guid) {\n            for (let n = 0; n < handlers.length; n++) {\n                if (handlers[n].guid === fn.guid) {\n                    handlers.splice(n--, 1);\n                }\n            }\n        }\n        _cleanUpEvents(elem, type);\n    }\n    function trigger(elem, event, hash) {\n        const elemData = DomData.has(elem) ? DomData.get(elem) : {};\n        const parent = elem.parentNode || elem.ownerDocument;\n        if (typeof event === 'string') {\n            event = {\n                type: event,\n                target: elem\n            };\n        } else if (!event.target) {\n            event.target = elem;\n        }\n        event = fixEvent(event);\n        if (elemData.dispatcher) {\n            elemData.dispatcher.call(elem, event, hash);\n        }\n        if (parent && !event.isPropagationStopped() && event.bubbles === true) {\n            trigger.call(null, parent, event, hash);\n        } else if (!parent && !event.defaultPrevented && event.target && event.target[event.type]) {\n            if (!DomData.has(event.target)) {\n                DomData.set(event.target, {});\n            }\n            const targetData = DomData.get(event.target);\n            if (event.target[event.type]) {\n                targetData.disabled = true;\n                if (typeof event.target[event.type] === 'function') {\n                    event.target[event.type]();\n                }\n                targetData.disabled = false;\n            }\n        }\n        return !event.defaultPrevented;\n    }\n    function one(elem, type, fn) {\n        if (Array.isArray(type)) {\n            return _handleMultipleEvents(one, elem, type, fn);\n        }\n        const func = function () {\n            off(elem, type, func);\n            fn.apply(this, arguments);\n        };\n        func.guid = fn.guid = fn.guid || Guid.newGUID();\n        on(elem, type, func);\n    }\n    function any(elem, type, fn) {\n        const func = function () {\n            off(elem, type, func);\n            fn.apply(this, arguments);\n        };\n        func.guid = fn.guid = fn.guid || Guid.newGUID();\n        on(elem, type, func);\n    }\n    return {\n        fixEvent: fixEvent,\n        on: on,\n        off: off,\n        trigger: trigger,\n        one: one,\n        any: any\n    };\n});"]}