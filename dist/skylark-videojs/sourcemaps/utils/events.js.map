{"version":3,"sources":["utils/events.js"],"names":["define","document","domx","DomData","Guid","log","fixEvent","event","fixed_","returnTrue","returnFalse","isPropagationStopped","old","window","key","preventDefault","target","srcElement","relatedTarget","fromElement","toElement","returnValue","defaultPrevented","stopPropagation","cancelBubble","stopImmediatePropagation","isImmediatePropagationStopped","clientX","undefined","doc","documentElement","body","pageX","scrollLeft","clientLeft","pageY","clientY","scrollTop","clientTop","which","charCode","keyCode","button","on","eventer","off","trigger","one","any"],"mappings":";;;;;;;AAAAA,QACI,iCACA,eACA,aACA,SACA,SACD,SAAUC,EAAUC,EAAMC,EAASC,EAAMC,GACxC,aA4BA,SAASC,EAASC,GACd,GAAIA,EAAMC,OACN,OAAOD,EAEX,SAASE,IACL,OAAO,EAEX,SAASC,IACL,OAAO,EAEX,IAAKH,IAAUA,EAAMI,qBAAsB,CACvC,MAAMC,EAAML,GAASM,OAAON,MAC5BA,KACA,IAAK,MAAMO,KAAOF,EACF,WAARE,GAA4B,WAARA,GAA4B,gBAARA,GAAiC,oBAARA,GAAqC,oBAARA,IAChF,gBAARA,GAAyBF,EAAIG,iBAC/BR,EAAMO,GAAOF,EAAIE,KAoC7B,GAhCKP,EAAMS,SACPT,EAAMS,OAAST,EAAMU,YAAchB,GAElCM,EAAMW,gBACPX,EAAMW,cAAgBX,EAAMY,cAAgBZ,EAAMS,OAAST,EAAMa,UAAYb,EAAMY,aAEvFZ,EAAMQ,eAAiB,WACfH,EAAIG,gBACJH,EAAIG,iBAERR,EAAMc,aAAc,EACpBT,EAAIS,aAAc,EAClBd,EAAMe,kBAAmB,GAE7Bf,EAAMe,kBAAmB,EACzBf,EAAMgB,gBAAkB,WAChBX,EAAIW,iBACJX,EAAIW,kBAERhB,EAAMiB,cAAe,EACrBZ,EAAIY,cAAe,EACnBjB,EAAMI,qBAAuBF,GAEjCF,EAAMI,qBAAuBD,EAC7BH,EAAMkB,yBAA2B,WACzBb,EAAIa,0BACJb,EAAIa,2BAERlB,EAAMmB,8BAAgCjB,EACtCF,EAAMgB,mBAEVhB,EAAMmB,8BAAgChB,EAChB,OAAlBH,EAAMoB,cAAsCC,IAAlBrB,EAAMoB,QAAuB,CACvD,MAAME,EAAM5B,EAAS6B,gBACfC,EAAO9B,EAAS8B,KACtBxB,EAAMyB,MAAQzB,EAAMoB,SAAWE,GAAOA,EAAII,YAAcF,GAAQA,EAAKE,YAAc,IAAMJ,GAAOA,EAAIK,YAAcH,GAAQA,EAAKG,YAAc,GAC7I3B,EAAM4B,MAAQ5B,EAAM6B,SAAWP,GAAOA,EAAIQ,WAAaN,GAAQA,EAAKM,WAAa,IAAMR,GAAOA,EAAIS,WAAaP,GAAQA,EAAKO,WAAa,GAE7I/B,EAAMgC,MAAQhC,EAAMiC,UAAYjC,EAAMkC,QACjB,OAAjBlC,EAAMmC,aAAoCd,IAAjBrB,EAAMmC,SAC/BnC,EAAMmC,OAAwB,EAAfnC,EAAMmC,OAAa,EAAmB,EAAfnC,EAAMmC,OAAa,EAAmB,EAAfnC,EAAMmC,OAAa,EAAI,GAI5F,OADAnC,EAAMC,QAAS,EACRD,EAwKX,OACID,SAAUA,EACVqC,GAAIzC,EAAK0C,QAAQD,GACjBE,IAAK3C,EAAK0C,QAAQC,IAClBC,QAAS5C,EAAK0C,QAAQE,QACtBC,IAAK7C,EAAK0C,QAAQG,IAClBC,IAAK9C,EAAK0C,QAAQG","file":"../../utils/events.js","sourcesContent":["define([\n    'skylark-langx-globals/document',\n    \"skylark-domx\",\n    './dom-data',\n    './guid',\n    './log'\n], function (document, domx, DomData, Guid, log) {\n    'use strict';\n    function _cleanUpEvents(elem, type) {\n        if (!DomData.has(elem)) {\n            return;\n        }\n        const data = DomData.get(elem);\n        if (data.handlers[type].length === 0) {\n            delete data.handlers[type];\n            if (elem.removeEventListener) {\n                elem.removeEventListener(type, data.dispatcher, false);\n            } else if (elem.detachEvent) {\n                elem.detachEvent('on' + type, data.dispatcher);\n            }\n        }\n        if (Object.getOwnPropertyNames(data.handlers).length <= 0) {\n            delete data.handlers;\n            delete data.dispatcher;\n            delete data.disabled;\n        }\n        if (Object.getOwnPropertyNames(data).length === 0) {\n            DomData.delete(elem);\n        }\n    }\n    function _handleMultipleEvents(fn, elem, types, callback) {\n        types.forEach(function (type) {\n            fn(elem, type, callback);\n        });\n    }\n    function fixEvent(event) {\n        if (event.fixed_) {\n            return event;\n        }\n        function returnTrue() {\n            return true;\n        }\n        function returnFalse() {\n            return false;\n        }\n        if (!event || !event.isPropagationStopped) {\n            const old = event || window.event;\n            event = {};\n            for (const key in old) {\n                if (key !== 'layerX' && key !== 'layerY' && key !== 'keyLocation' && key !== 'webkitMovementX' && key !== 'webkitMovementY') {\n                    if (!(key === 'returnValue' && old.preventDefault)) {\n                        event[key] = old[key];\n                    }\n                }\n            }\n            if (!event.target) {\n                event.target = event.srcElement || document;\n            }\n            if (!event.relatedTarget) {\n                event.relatedTarget = event.fromElement === event.target ? event.toElement : event.fromElement;\n            }\n            event.preventDefault = function () {\n                if (old.preventDefault) {\n                    old.preventDefault();\n                }\n                event.returnValue = false;\n                old.returnValue = false;\n                event.defaultPrevented = true;\n            };\n            event.defaultPrevented = false;\n            event.stopPropagation = function () {\n                if (old.stopPropagation) {\n                    old.stopPropagation();\n                }\n                event.cancelBubble = true;\n                old.cancelBubble = true;\n                event.isPropagationStopped = returnTrue;\n            };\n            event.isPropagationStopped = returnFalse;\n            event.stopImmediatePropagation = function () {\n                if (old.stopImmediatePropagation) {\n                    old.stopImmediatePropagation();\n                }\n                event.isImmediatePropagationStopped = returnTrue;\n                event.stopPropagation();\n            };\n            event.isImmediatePropagationStopped = returnFalse;\n            if (event.clientX !== null && event.clientX !== undefined) {\n                const doc = document.documentElement;\n                const body = document.body;\n                event.pageX = event.clientX + (doc && doc.scrollLeft || body && body.scrollLeft || 0) - (doc && doc.clientLeft || body && body.clientLeft || 0);\n                event.pageY = event.clientY + (doc && doc.scrollTop || body && body.scrollTop || 0) - (doc && doc.clientTop || body && body.clientTop || 0);\n            }\n            event.which = event.charCode || event.keyCode;\n            if (event.button !== null && event.button !== undefined) {\n                event.button = event.button & 1 ? 0 : event.button & 4 ? 1 : event.button & 2 ? 2 : 0;\n            }\n        }\n        event.fixed_ = true;\n        return event;\n    }\n    let _supportsPassive;\n    const supportsPassive = function () {\n        if (typeof _supportsPassive !== 'boolean') {\n            _supportsPassive = false;\n            try {\n                const opts = Object.defineProperty({}, 'passive', {\n                    get() {\n                        _supportsPassive = true;\n                    }\n                });\n                window.addEventListener('test', null, opts);\n                window.removeEventListener('test', null, opts);\n            } catch (e) {\n            }\n        }\n        return _supportsPassive;\n    };\n    const passiveEvents = [\n        'touchstart',\n        'touchmove'\n    ];\n    function on(elem, type, fn) {\n        if (Array.isArray(type)) {\n            return _handleMultipleEvents(on, elem, type, fn);\n        }\n        if (!DomData.has(elem)) {\n            DomData.set(elem, {});\n        }\n        const data = DomData.get(elem);\n        if (!data.handlers) {\n            data.handlers = {};\n        }\n        if (!data.handlers[type]) {\n            data.handlers[type] = [];\n        }\n        if (!fn.guid) {\n            fn.guid = Guid.newGUID();\n        }\n        data.handlers[type].push(fn);\n        if (!data.dispatcher) {\n            data.disabled = false;\n            data.dispatcher = function (event, hash) {\n                if (data.disabled) {\n                    return;\n                }\n                event = fixEvent(event);\n                const handlers = data.handlers[event.type];\n                if (handlers) {\n                    const handlersCopy = handlers.slice(0);\n                    for (let m = 0, n = handlersCopy.length; m < n; m++) {\n                        if (event.isImmediatePropagationStopped()) {\n                            break;\n                        } else {\n                            try {\n                                handlersCopy[m].call(elem, event, hash);\n                            } catch (e) {\n                                log.error(e);\n                            }\n                        }\n                    }\n                }\n            };\n        }\n        if (data.handlers[type].length === 1) {\n            if (elem.addEventListener) {\n                let options = false;\n                if (supportsPassive() && passiveEvents.indexOf(type) > -1) {\n                    options = { passive: true };\n                }\n                elem.addEventListener(type, data.dispatcher, options);\n            } else if (elem.attachEvent) {\n                elem.attachEvent('on' + type, data.dispatcher);\n            }\n        }\n    }\n    function off(elem, type, fn) {\n        if (!DomData.has(elem)) {\n            return;\n        }\n        const data = DomData.get(elem);\n        if (!data.handlers) {\n            return;\n        }\n        if (Array.isArray(type)) {\n            return _handleMultipleEvents(off, elem, type, fn);\n        }\n        const removeType = function (el, t) {\n            data.handlers[t] = [];\n            _cleanUpEvents(el, t);\n        };\n        if (type === undefined) {\n            for (const t in data.handlers) {\n                if (Object.prototype.hasOwnProperty.call(data.handlers || {}, t)) {\n                    removeType(elem, t);\n                }\n            }\n            return;\n        }\n        const handlers = data.handlers[type];\n        if (!handlers) {\n            return;\n        }\n        if (!fn) {\n            removeType(elem, type);\n            return;\n        }\n        if (fn.guid) {\n            for (let n = 0; n < handlers.length; n++) {\n                if (handlers[n].guid === fn.guid) {\n                    handlers.splice(n--, 1);\n                }\n            }\n        }\n        _cleanUpEvents(elem, type);\n    }\n    function trigger(elem, event, hash) {\n        const elemData = DomData.has(elem) ? DomData.get(elem) : {};\n        const parent = elem.parentNode || elem.ownerDocument;\n        if (typeof event === 'string') {\n            event = {\n                type: event,\n                target: elem\n            };\n        } else if (!event.target) {\n            event.target = elem;\n        }\n        event = fixEvent(event);\n        if (elemData.dispatcher) {\n            elemData.dispatcher.call(elem, event, hash);\n        }\n        if (parent && !event.isPropagationStopped() && event.bubbles === true) {\n            trigger.call(null, parent, event, hash);\n        } else if (!parent && !event.defaultPrevented && event.target && event.target[event.type]) {\n            if (!DomData.has(event.target)) {\n                DomData.set(event.target, {});\n            }\n            const targetData = DomData.get(event.target);\n            if (event.target[event.type]) {\n                targetData.disabled = true;\n                if (typeof event.target[event.type] === 'function') {\n                    event.target[event.type]();\n                }\n                targetData.disabled = false;\n            }\n        }\n        return !event.defaultPrevented;\n    }\n    function one(elem, type, fn) {\n        if (Array.isArray(type)) {\n            return _handleMultipleEvents(one, elem, type, fn);\n        }\n        const func = function () {\n            off(elem, type, func);\n            fn.apply(this, arguments);\n        };\n        func.guid = fn.guid = fn.guid || Guid.newGUID();\n        on(elem, type, func);\n    }\n    function any(elem, type, fn) {\n        const func = function () {\n            off(elem, type, func);\n            fn.apply(this, arguments);\n        };\n        func.guid = fn.guid = fn.guid || Guid.newGUID();\n        on(elem, type, func);\n    }\n    return {\n        fixEvent: fixEvent,\n        on: domx.eventer.on, //on,\n        off: domx.eventer.off, //off,\n        trigger: domx.eventer.trigger, //trigger,\n        one: domx.eventer.one, //one,\n        any: domx.eventer.one //any\n    };\n});"]}